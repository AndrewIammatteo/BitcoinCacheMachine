#!/bin/bash

set -Eeuo pipefail
cd "$(dirname "$0")"

if [[ -z $BCM_ACTIVE ]]; then
    BCM_ACTIVE=1
fi

# shellcheck disable=1090
source ./env

if snap list | grep -q docker; then
    if ! docker image list --format "{{.Repository}}" | grep -q "bcm-trezor"; then
        CHOICE=
        read -rp "The docker image for the BCM SDN Controller is unavailable. Would you like to build it now (n/y): " CHOICE
        if [[ $CHOICE == "y" ]]; then
            bash -c "$BCM_GIT_DIR/controller/build.sh"
        else
            exit
        fi
    fi
fi

# # check to see if we have Trezor-backed GPG certificates.  If not, let's create them.
# if bcm info | grep -q "BCM_DEFAULT_KEY_ID"; then
#     echo "Trezor-backed GPG certificates were not found."

#     # Init your SDN controller; create a new GPG certificate 'Satoshi Nakamoto satoshi@bitcoin.org'
#     bcm init --cert-name="Satoshi Nakamoto" --username="satoshi" --hostname="bitcoin.org"
# fi

if grep -qs "$BCM_WORKING_DIR" /proc/mounts; then
    mkdir -p "$BCM_WORKING_DIR""_enc"
    mkdir -p "$BCM_WORKING_DIR"
    encfs "$BCM_WORKING_DIR""_enc" "$BCM_WORKING_DIR" -i=10 --extpass="apg -n 1 -m 30 -M CN" >> /dev/null
fi

mkdir -p "$BCM_SSH_DIR"
mkdir -p "$BCM_WORKING_DIR"

# call the CLI entrypoint.
./commands/cli_entrypoint.sh "$@"
