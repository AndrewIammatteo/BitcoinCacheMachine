#!/bin/bash

set -e
cd "$(dirname "$0")"

if [[ -z $BCM_ACTIVE ]]; then
    BCM_ACTIVE=1
fi

# shellcheck disable=1090
source "$BCM_GIT_DIR/env"

if snap list | grep -q docker; then
    if ! sudo docker image list --format "{{.Repository}}" | grep -q "bcm-trezor"; then
        CHOICE=
        read -rp "The BCM docker image for the SDN Controller is unavailable. Would you like to build it now (n/y): " CHOICE
        if [[ $CHOICE == "y" ]]; then
            bash -c "$BCM_GIT_DIR/controller/build.sh"
        else
            exit
        fi
    fi
fi

# Only run commands if we have local LXD installed.
if snap list | grep -q lxd; then
    ./commands/cli_entrypoint.sh "$@"
else
    echo "ERROR: The LXD snap is not installed locally."
    bash -c "$BCM_GIT_DIR/cli/commands/install/snap_install_lxd_local.sh"
fi
