version: '3.7'
services:
  lnd:
    image: ${IMAGE_NAME}
    hostname: lnd-${CHAIN:-testnet}
    volumes:
      - lnd-data:/root/.lnd
      - lnd-certificate-data:/config
      - lnd-macaroon-data:/macaroons
      - lnd-log-data:/var/logs/lnd
      - bitcoin_data:/bitcoin/data
      - bitcoin_cli:/usr/local/bin
    environment:
      LND_CERTIFICATE_HOSTNAME: lnd-${CHAIN:-testnet}  #this is so there are no certificate verification issues on lncli-web
      CHAIN: ${CHAIN:-testnet}
      LXC_HOSTNAME: ${LXC_HOSTNAME}
    networks:
      bitcoindrpcnet:
      lndrpcnet:
        aliases:
          - lndrpc-${CHAIN}
    secrets:
      - source: lnd-config
        target: /root/.lnd/lnd.conf
        uid: '0'
        gid: '0'
        mode: 0444
    deploy:
      mode: replicated
      replicas: 1
      placement:
        constraints:
          - engine.labels.bcm-bitcoin == true


networks:
  lndrpcnet:
    driver: overlay
    attachable: true

  bitcoindrpcnet:
    external: true
    name: bitcoind-${CHAIN:-testnet}_bitcoindrpcnet
  

secrets:
  lnd-config:
    file: "lnd-${CHAIN:-testnet}.conf"

volumes:
  lnd-data:
  lnd-log-data:
  
  lnd-certificate-data:  
  lnd-macaroon-data: 

  bitcoin_data:
    external: true
    name: bitcoind-${CHAIN:-testnet}_bitcoin_data

  bitcoin_cli:
    external: true
    name: bitcoind-${CHAIN:-testnet}_bitcoin_cli
