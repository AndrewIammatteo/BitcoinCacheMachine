version: '3.7'
services:
  lnd:
    image: ${IMAGE_NAME}
    hostname: lnd-${BCM_ACTIVE_CHAIN:-testnet}
    volumes:
      - lnd-data:/root/.lnd
      - lnd-certificate-data:/config
      - lnd-macaroon-data:/macaroons
      - lnd-log-data:/var/logs/lnd
      - bitcoin_data:/bitcoin/data
      - bitcoin_cli:/usr/local/bin
    environment:
      LND_CERTIFICATE_HOSTNAME: lnd-${BCM_ACTIVE_CHAIN:-}  #this is so there are no certificate verification issues on lncli-web
      BCM_ACTIVE_CHAIN: ${BCM_ACTIVE_CHAIN:-}
      LXC_HOSTNAME: ${LXC_HOSTNAME}
      BITCOIND_RPC_PORT: ${BITCOIND_RPC_PORT}
      BITCOIND_ZMQ_BLOCK_PORT: ${BITCOIND_ZMQ_BLOCK_PORT}
      BITCOIND_ZMQ_TX_PORT: ${BITCOIND_ZMQ_TX_PORT}
      CHAIN_TEXT: ${CHAIN_TEXT}
      BITCOIND_RPC_USERNAME: ${BITCOIND_RPC_USERNAME:-bitcoin}
      BITCOIND_RPC_PASSWORD: ${BITCOIND_RPC_PASSWORD:-password}
    networks:
      bitcoindrpcnet:
      lndrpcnet:
        aliases:
          - lndrpc-${BCM_ACTIVE_CHAIN}
    secrets:
      - source: lnd-config
        target: /root/.lnd/lnd.conf
        uid: '0'
        gid: '0'
        mode: 0444
    deploy:
      mode: replicated
      replicas: 1
      placement:
        constraints:
          - engine.labels.bcm-bitcoin == true


networks:
  lndrpcnet:
    driver: overlay
    attachable: true

  bitcoindrpcnet:
    external: true
    name: bitcoind-${BCM_ACTIVE_CHAIN:-}_bitcoindrpcnet
  

secrets:
  lnd-config:
    file: "lnd-${BCM_ACTIVE_CHAIN:-}.conf"

volumes:
  lnd-data:
  lnd-log-data:
  
  lnd-certificate-data:  
  lnd-macaroon-data: 

  bitcoin_data:
    external: true
    name: bitcoind-${BCM_ACTIVE_CHAIN:-}_bitcoin_data

  bitcoin_cli:
    external: true
    name: bitcoind-${BCM_ACTIVE_CHAIN:-}_bitcoin_cli
